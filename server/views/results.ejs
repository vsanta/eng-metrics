<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Analysis Results</title>
    <!-- Include D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Basic styling for the scatter plot and tooltip */
        #tooltip {
            position: absolute;
            display: none;
            padding: 8px;
            background-color: lightgray;
            border: 1px solid #333;
            border-radius: 4px;
        }
        /* Side panel styling */
        #sidePanel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100%;
            background: #f7f7f7;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
        }
        #sidePanel.open {
            right: 0;
        }
        #sidePanel h2 {
            margin-top: 0;
        }
        #closePanel {
            cursor: pointer;
            float: right;
            font-size: 18px;
            font-weight: bold;
        }
        /* Network graph styling */
        #networkGraph {
            margin-top: 30px;
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        /* Raw data styling */
        .raw-data-section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        #commitsTable {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        #commitsTable table {
            width: 100%;
            border-collapse: collapse;
        }
        #commitsTable th, #commitsTable td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        #commitsTable th {
            background-color: #f1f1f1;
            position: sticky;
            top: 0;
        }
        #loadMoreCommits {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
        }
        #loadMoreCommits:hover {
            background-color: #3e8e41;
        }
        /* Tab styling */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-top: 20px;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tabcontent.active {
            display: block;
        }
    </style>
</head>
<body>
<h1>Analysis Complete</h1>
<p>Total Creates: <%= totalCreates %></p>
<p>Total Edits: <%= totalEdits %></p>
<p>Since Date: <%= sinceDate %></p>

<!-- Store the analysis key so it can be used by the front end -->
<script>
    const analysisKey = "<%= analysisKey %>";
</script>

<!-- Tabs -->
<div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'scatterPlotTab')">Scatter Plot</button>
    <button class="tablinks" onclick="openTab(event, 'networkTab')">Collaboration Network</button>
    <button class="tablinks" onclick="openTab(event, 'rawDataTab')">Raw Data</button>
</div>

<!-- Scatter Plot Tab -->
<div id="scatterPlotTab" class="tabcontent active">
    <div id="scatterPlot"></div>
    <div id="tooltip"></div>
</div>

<!-- Network Graph Tab -->
<div id="networkTab" class="tabcontent">
    <h2>Collaboration Network</h2>
    <p>This graph shows how developers collaborate. Each link represents one developer editing files created by another.</p>
    <p>Thicker lines indicate more frequent collaboration.</p>
    <div id="networkGraph"></div>
</div>

<!-- Raw Data Tab -->
<div id="rawDataTab" class="tabcontent">
    <h2>Raw Git Data</h2>
    <p>This tab shows the raw git data collected during analysis.</p>
    
    <div class="raw-data-section">
        <h3>Recent Commits</h3>
        <div id="commitsTable"></div>
        <button id="loadMoreCommits">Load More</button>
    </div>
    
    <div class="raw-data-section">
        <h3>File Change Types</h3>
        <div id="fileChangeTypes"></div>
    </div>
    
    <div class="raw-data-section">
        <h3>File Extensions</h3>
        <div id="fileExtensions"></div>
    </div>
    
    <div class="raw-data-section">
        <h3>Commit Activity</h3>
        <div id="commitActivity"></div>
    </div>
    
    <div class="raw-data-section">
        <h3>PR Lifecycle</h3>
        <div id="prLifecycle"></div>
    </div>
    
    <div class="raw-data-section">
        <h3>Hot Files (Most Changed)</h3>
        <div id="hotFiles"></div>
    </div>
    
    <div class="raw-data-section">
        <h3>Work Type by Contributor</h3>
        <div id="commitTypes"></div>
    </div>
</div>

<!-- Top 20 Influencers -->
<h2>Top 20 Influencers</h2>
<ul>
    <% topInfluencers.forEach(influencer => { %>
        <li>
            <strong><%= influencer.author %></strong> – Influence Score: <%= influencer.influenceScore %>
            (Creates: <%= influencer.total_creates %>, Edits: <%= influencer.total_edits %>,
            Edited on Created Files: <%= influencer.times_edited_on_created_files %>)
        </li>
    <% }); %>
</ul>

<!-- Top 20 Creators -->
<h2>Top 20 Creators</h2>
<ul>
    <% topCreators.forEach(creator => { %>
        <li>
            <strong><%= creator.author %></strong> – Creates: <%= creator.creates %>
        </li>
    <% }); %>
</ul>

<!-- Top 20 Editors -->
<h2>Top 20 Editors</h2>
<ul>
    <% topEditors.forEach(editor => { %>
        <li>
            <strong><%= editor.author %></strong> – Edits: <%= editor.edits %>
        </li>
    <% }); %>
</ul>

<!-- Top 20 People Who Create Files That Get Edited -->
<h2>Top 20 People Whose Files Get Edited</h2>
<ul>
    <% topEditedCreators.forEach(item => { %>
        <li>
            <strong><%= item.author %></strong> – Times Edited: <%= item.times_edited %>
        </li>
    <% }); %>
</ul>
<!-- Side panel for detailed contributor info -->
<div id="sidePanel">
    <span id="closePanel">&times;</span>
    <div id="panelContent"></div>
</div>

<script>
    // Data injected from the server
    const dataPoints = <%- JSON.stringify(contributors || []) %>;
    const networkData = <%- JSON.stringify(networkData || []) %>;

    // Function to open tabs
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tabcontent");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }
        
        const tablinks = document.getElementsByClassName("tablinks");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    // Scatter Plot Visualization
    const width = 600, height = 400;
    const margin = { top: 50, right: 50, bottom: 50, left: 50 };

    const svg = d3.select("#scatterPlot")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // Scales: x for creates, y for edits.
    const xScale = d3.scaleLinear()
        .domain([0, d3.max(dataPoints, d => d.creates) + 5])
        .range([margin.left, width - margin.right]);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(dataPoints, d => d.edits) + 5])
        .range([height - margin.bottom, margin.top]);

    // X-axis (File Creations)
    const xAxis = d3.axisBottom(xScale);
    svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .call(xAxis)
        .append("text")
        .attr("x", width - margin.right)
        .attr("y", -10)
        .attr("fill", "#000")
        .style("text-anchor", "end")
        .text("File Creations");

    // Y-axis (File Edits)
    const yAxis = d3.axisLeft(yScale);
    svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -margin.top)
        .attr("y", 15)
        .attr("fill", "#000")
        .style("text-anchor", "end")
        .text("File Edits");

    // Tooltip for hover effect
    const tooltip = d3.select("#tooltip");

    // Plot data points with click handler to load contributor details
    svg.selectAll("circle")
        .data(dataPoints)
        .enter()
        .append("circle")
        .attr("cx", d => xScale(d.creates))
        .attr("cy", d => yScale(d.edits))
        .attr("r", 8)
        .attr("fill", "steelblue")
        .on("mouseover", function(event, d) {
            tooltip.style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .style("display", "inline-block")
                .html(`<strong>${d.author}</strong><br/>Creates: ${d.creates}<br/>Edits: ${d.edits}`);
        })
        .on("mouseout", () => {
            tooltip.style("display", "none");
        })
        .on("click", function(event, d) {
            // Include the analysisKey in the query parameter
            fetch(`/api/contributor/${encodeURIComponent(d.author)}?analysisKey=${encodeURIComponent(analysisKey)}`)
                .then(response => response.json())
                .then(details => {
                    showSidePanel(details);
                })
                .catch(err => {
                    console.error('Error fetching contributor details:', err);
                });
        });

    // Function to show side panel with contributor details
    function showSidePanel(details) {
        const panel = document.getElementById('sidePanel');
        const panelContent = document.getElementById('panelContent');
        panelContent.innerHTML = `
        <h2>${details.influenceRank} ${details.author}</h2>
        <p><strong>Creates:</strong> ${details.creates}</p>
        <p><strong>Edits:</strong> ${details.edits}</p>
        <p><strong>Edits on their files:</strong> ${details.editsToCreations}</p>
        <p><strong>Influence Score:</strong> ${details.influenceScore}</p>
        <p style="font-size: 0.9em; color: #555;">
          <em>
            Influence Score is calculated as: Edits + (Creates × Multiplier), where
            Multiplier = (Edits on created files > 0 ? Edits on created files : 1)
          </em>
        </p>
        <h3>Contributions per Repository</h3>
        ${details.perRepo && details.perRepo.length > 0 ? `
          <ul>
            ${details.perRepo.map(repo => `<li>${repo.repository}: ${repo.creates} creates, ${repo.edits} edits</li>`).join('')}
          </ul>
        ` : '<p>No per-repository data available.</p>'}
      `;
        panel.classList.add('open');
    }

    // Function to hide the side panel
    document.getElementById('closePanel').addEventListener('click', () => {
        document.getElementById('sidePanel').classList.remove('open');
    });

    // Tab Initializations
    document.addEventListener('DOMContentLoaded', function() {
        // Create force-directed graph when network tab is clicked
        document.querySelector('button[onclick="openTab(event, \'networkTab\')"]').addEventListener('click', createNetworkGraph);
        
        // Load raw data when raw data tab is clicked
        document.querySelector('button[onclick="openTab(event, \'rawDataTab\')"]').addEventListener('click', initRawDataTab);
    });

    function createNetworkGraph() {
        // Only create the graph once
        if (document.querySelector('#networkGraph svg')) return;
        
        const graphWidth = document.getElementById('networkGraph').clientWidth;
        const graphHeight = 500;
        
        // Create nodes from unique creators and editors
        const uniqueAuthors = new Set();
        networkData.forEach(d => {
            uniqueAuthors.add(d.creator);
            uniqueAuthors.add(d.editor);
        });
        
        const nodes = Array.from(uniqueAuthors).map(name => ({ id: name }));
        
        // Create links from collaboration data
        const links = networkData.map(d => ({
            source: d.creator,
            target: d.editor,
            value: d.collaboration_count
        }));
        
        // Create color scale for the nodes
        const color = d3.scaleOrdinal(d3.schemeCategory10);
        
        // Create force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody().strength(-200))
            .force("center", d3.forceCenter(graphWidth / 2, graphHeight / 2))
            .force("collision", d3.forceCollide().radius(30));
        
        // Create SVG for the network
        const svg = d3.select("#networkGraph")
            .append("svg")
            .attr("width", graphWidth)
            .attr("height", graphHeight);
            
        // Define arrow markers for directed graph
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("orient", "auto")
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#999");
            
        // Add links with varying stroke-width based on collaboration count
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrowhead)")
            .style("stroke-width", d => Math.sqrt(d.value));
            
        // Create node group for circles and labels
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .enter().append("g")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
                
        // Add circle to each node
        node.append("circle")
            .attr("class", "node")
            .attr("r", 10)
            .attr("fill", d => color(d.id))
            .append("title")
            .text(d => d.id);
            
        // Add text label to each node
        node.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(d => d.id);
            
        // Update positions on each tick of the simulation
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
                
            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
    
    // Raw data visualization functions
    function initRawDataTab() {
        if (document.querySelector('#commitsTable table')) return; // Only load once
        
        // Load all data in parallel
        Promise.all([
            fetch(`/api/commits/${analysisKey}`).then(res => res.json()),
            fetch(`/api/analytics/changes-by-type/${analysisKey}`).then(res => res.json()),
            fetch(`/api/analytics/file-extensions/${analysisKey}`).then(res => res.json()),
            fetch(`/api/analytics/commits-by-day/${analysisKey}`).then(res => res.json()),
            fetch(`/api/analytics/pr-lifecycle/${analysisKey}`).then(res => res.json()),
            fetch(`/api/analytics/hot-files/${analysisKey}`).then(res => res.json()),
            fetch(`/api/analytics/commit-types/${analysisKey}`).then(res => res.json())
        ])
        .then(([commits, changeTypes, fileExtensions, commitsByDay, prLifecycle, hotFiles, commitTypes]) => {
            renderCommitsTable(commits.slice(0, 50)); // Show first 50 commits
            renderFileChangeTypes(changeTypes);
            renderFileExtensions(fileExtensions);
            renderCommitActivity(commitsByDay);
            renderPRLifecycle(prLifecycle);
            renderHotFiles(hotFiles);
            renderCommitTypes(commitTypes);
            
            // Store all commits for pagination
            window.allCommits = commits;
            window.currentPage = 1;
            
            // Add event listener for "Load More" button
            document.getElementById('loadMoreCommits').addEventListener('click', loadMoreCommits);
        })
        .catch(error => {
            console.error('Error loading raw data:', error);
            document.querySelectorAll('.raw-data-section').forEach(section => {
                section.innerHTML = '<p>Error loading data. Please try again.</p>';
            });
        });
    }
    
    function loadMoreCommits() {
        window.currentPage++;
        const start = (window.currentPage - 1) * 50;
        const end = start + 50;
        const commits = window.allCommits.slice(start, end);
        
        if (commits.length === 0) {
            document.getElementById('loadMoreCommits').disabled = true;
            document.getElementById('loadMoreCommits').textContent = 'No More Commits';
            return;
        }
        
        // Append to the existing table
        const tbody = document.querySelector('#commitsTable table tbody');
        commits.forEach(commit => {
            const row = document.createElement('tr');
            
            // Format the date
            const date = new Date(commit.timestamp);
            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            
            row.innerHTML = `
                <td>${commit.hash.substring(0, 7)}</td>
                <td>${commit.author}</td>
                <td>${formattedDate}</td>
                <td>${commit.message}</td>
                <td>
                    <button onclick="showFileChanges('${commit.hash}')">View Changes</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function renderCommitsTable(commits) {
        const container = document.getElementById('commitsTable');
        
        // Create table
        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Commit ID</th>
                    <th>Author</th>
                    <th>Date</th>
                    <th>Message</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        // Add rows
        const tbody = table.querySelector('tbody');
        commits.forEach(commit => {
            const row = document.createElement('tr');
            
            // Format the date
            const date = new Date(commit.timestamp);
            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            
            row.innerHTML = `
                <td>${commit.hash.substring(0, 7)}</td>
                <td>${commit.author}</td>
                <td>${formattedDate}</td>
                <td>${commit.message}</td>
                <td>
                    <button onclick="showFileChanges('${commit.hash}')">View Changes</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        container.appendChild(table);
    }
    
    function renderFileChangeTypes(changeTypes) {
        const container = document.getElementById('fileChangeTypes');
        
        // Create SVG for pie chart
        const width = 300;
        const height = 300;
        const radius = Math.min(width, height) / 2;
        
        const svg = d3.select(container)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);
            
        // Create color scale
        const color = d3.scaleOrdinal()
            .domain(changeTypes.map(d => d.status))
            .range(d3.schemeCategory10);
            
        // Map status codes to readable names
        const statusNames = {
            'A': 'Added',
            'M': 'Modified',
            'D': 'Deleted',
            'R': 'Renamed',
            'C': 'Copied',
            'T': 'Type Changed'
        };
        
        // Format the data for pie chart
        const data = changeTypes.map(d => ({
            status: statusNames[d.status] || d.status,
            count: d.change_count
        }));
            
        // Create pie chart
        const pie = d3.pie()
            .value(d => d.count);
            
        const data_ready = pie(data);
            
        // Build arcs
        const arcGenerator = d3.arc()
            .innerRadius(0)
            .outerRadius(radius);
            
        // Add tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute")
            .style("background-color", "white")
            .style("border", "1px solid #ddd")
            .style("padding", "10px")
            .style("border-radius", "4px")
            .style("pointer-events", "none");
            
        // Add slices
        svg.selectAll('slices')
            .data(data_ready)
            .enter()
            .append('path')
            .attr('d', arcGenerator)
            .attr('fill', d => color(d.data.status))
            .attr('stroke', 'white')
            .style('stroke-width', '2px')
            .on('mouseover', function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`${d.data.status}: ${d.data.count} (${(d.data.count / d3.sum(data, d => d.count) * 100).toFixed(1)}%)`)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on('mouseout', function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
            
        // Add labels
        svg.selectAll('labels')
            .data(data_ready)
            .enter()
            .append('text')
            .text(d => d.data.status)
            .attr('transform', d => `translate(${arcGenerator.centroid(d)})`)
            .style('text-anchor', 'middle')
            .style('font-size', '12px')
            .style('fill', 'white');
    }
    
    function renderFileExtensions(extensions) {
        const container = document.getElementById('fileExtensions');
        
        // Create a bar chart for top 10 extensions
        const data = extensions.slice(0, 10);
        
        const margin = {top: 30, right: 30, bottom: 70, left: 60};
        const width = 500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;
        
        // Create SVG
        const svg = d3.select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
        // X axis
        const x = d3.scaleBand()
            .range([0, width])
            .domain(data.map(d => d.extension))
            .padding(0.2);
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");
            
        // Y axis
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.count) * 1.1])
            .range([height, 0]);
        svg.append("g")
            .call(d3.axisLeft(y));
            
        // Add bars
        svg.selectAll("bars")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", d => x(d.extension))
            .attr("y", d => y(d.count))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.count))
            .attr("fill", "#69b3a2");
            
        // Add title
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .text("Top 10 File Extensions");
    }
    
    function renderCommitActivity(commitsByDay) {
        const container = document.getElementById('commitActivity');
        
        // Group by date
        const dateGroups = {};
        commitsByDay.forEach(item => {
            if (!dateGroups[item.date]) {
                dateGroups[item.date] = 0;
            }
            dateGroups[item.date] += item.commit_count;
        });
        
        // Convert to array
        const data = Object.entries(dateGroups)
            .map(([date, count]) => ({date: new Date(date), count}))
            .sort((a, b) => a.date - b.date);
            
        // Define dimensions
        const margin = {top: 20, right: 30, bottom: 30, left: 50};
        const width = 800 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;
        
        // Create SVG
        const svg = d3.select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
        // X scale (time)
        const x = d3.scaleTime()
            .domain(d3.extent(data, d => d.date))
            .range([0, width]);
            
        // Y scale (linear)
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.count) * 1.1])
            .range([height, 0]);
            
        // Add X axis
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x));
            
        // Add Y axis
        svg.append("g")
            .call(d3.axisLeft(y));
            
        // Add the line
        svg.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 1.5)
            .attr("d", d3.line()
                .x(d => x(d.date))
                .y(d => y(d.count))
            );
            
        // Add points
        svg.selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", d => x(d.date))
            .attr("cy", d => y(d.count))
            .attr("r", 5)
            .attr("fill", "steelblue");
    }
    
    // Render PR lifecycle visualization
    function renderPRLifecycle(prData) {
        const container = document.getElementById('prLifecycle');
        
        if (!prData || !prData.length) {
            container.innerHTML = "<p>No PR lifecycle data available.</p>";
            return;
        }
        
        // Create a box plot for PR lifetime
        const margin = {top: 20, right: 30, bottom: 70, left: 60};
        const width = 600 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;
        
        // Create SVG
        const svg = d3.select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
        // Calculate lifetime stats in hours
        const lifetimes = prData.map(d => d.lifetime_minutes / 60);
        
        // Create a table with PR lifecycle data
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '20px';
        
        // Add header
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Branch</th>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Created By</th>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Merged By</th>
                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">Created Date</th>
                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">Merged Date</th>
                <th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Lifetime (hours)</th>
            </tr>
        `;
        table.appendChild(thead);
        
        // Add body
        const tbody = document.createElement('tbody');
        prData.forEach(pr => {
            const row = document.createElement('tr');
            const lifetimeHours = (pr.lifetime_minutes / 60).toFixed(1);
            const createdDate = new Date(pr.created_timestamp).toLocaleDateString();
            const mergedDate = pr.merged_timestamp ? new Date(pr.merged_timestamp).toLocaleDateString() : 'N/A';
            
            row.innerHTML = `
                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">${pr.branch_name}</td>
                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">${pr.created_by}</td>
                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">${pr.merged_by || 'N/A'}</td>
                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${createdDate}</td>
                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${mergedDate}</td>
                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${lifetimeHours}</td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);
        
        // Create statistics panel
        const stats = document.createElement('div');
        stats.style.marginTop = '20px';
        stats.style.fontWeight = 'bold';
        
        // Calculate statistics
        const avgLifetime = lifetimes.reduce((a, b) => a + b, 0) / lifetimes.length;
        const medianLifetime = lifetimes.sort((a, b) => a - b)[Math.floor(lifetimes.length / 2)];
        
        stats.innerHTML = `
            <p>Average PR Lifetime: ${avgLifetime.toFixed(1)} hours</p>
            <p>Median PR Lifetime: ${medianLifetime.toFixed(1)} hours</p>
            <p>Total PRs: ${prData.length}</p>
        `;
        container.appendChild(stats);
    }
    
    // Render hot files visualization
    function renderHotFiles(hotFilesData) {
        const container = document.getElementById('hotFiles');
        
        if (!hotFilesData || !hotFilesData.length) {
            container.innerHTML = "<p>No hot files data available.</p>";
            return;
        }
        
        // Create a bar chart for hot files
        const margin = {top: 30, right: 30, bottom: 120, left: 60};
        const width = 700 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        
        // Create SVG
        const svg = d3.select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
        // Prepare top 15 hottest files
        const data = hotFilesData.slice(0, 15);
        
        // X axis: files
        const x = d3.scaleBand()
            .range([0, width])
            .domain(data.map(d => d.filename))
            .padding(0.2);
        
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "10px");
        
        // Y axis: change count
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.change_count) * 1.1])
            .range([height, 0]);
        
        svg.append("g")
            .call(d3.axisLeft(y));
        
        // Color scale for contributor count
        const colorScale = d3.scaleLinear()
            .domain([1, d3.max(data, d => d.contributor_count)])
            .range(["#69b3a2", "#e41a1c"]);
        
        // Add a tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute")
            .style("background-color", "white")
            .style("border", "1px solid #ddd")
            .style("padding", "10px")
            .style("border-radius", "4px")
            .style("pointer-events", "none");
        
        // Add bars
        svg.selectAll("bars")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", d => x(d.filename))
            .attr("y", d => y(d.change_count))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.change_count))
            .attr("fill", d => colorScale(d.contributor_count))
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`
                    <strong>${d.filename}</strong><br/>
                    Changes: ${d.change_count}<br/>
                    Contributors: ${d.contributor_count}
                `)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        
        // Add title
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .text("Most Frequently Changed Files");
        
        // Add legend
        const legend = svg.append("g")
            .attr("transform", `translate(${width - 150}, 10)`);
        
        legend.append("text")
            .attr("x", 0)
            .attr("y", -5)
            .style("font-size", "12px")
            .text("Contributors:");
        
        const legendScale = d3.scaleLinear()
            .domain([1, d3.max(data, d => d.contributor_count)])
            .range([0, 100]);
        
        const legendAxis = d3.axisBottom(legendScale)
            .ticks(5)
            .tickSize(15);
        
        legend.append("g")
            .attr("transform", "translate(0, 30)")
            .call(legendAxis);
        
        // Create the gradient for the legend
        const defs = svg.append("defs");
        const gradient = defs.append("linearGradient")
            .attr("id", "legend-gradient")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");
        
        gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#69b3a2");
        
        gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#e41a1c");
        
        // Add rectangle with gradient
        legend.append("rect")
            .attr("width", 100)
            .attr("height", 15)
            .style("fill", "url(#legend-gradient)");
    }
    
    // Render commit types visualization
    function renderCommitTypes(commitTypesData) {
        const container = document.getElementById('commitTypes');
        
        if (!commitTypesData || !commitTypesData.length) {
            container.innerHTML = "<p>No commit type data available.</p>";
            return;
        }
        
        // Group data by author
        const authorGroups = {};
        commitTypesData.forEach(item => {
            if (!authorGroups[item.author]) {
                authorGroups[item.author] = [];
            }
            authorGroups[item.author].push({
                type: item.type,
                count: item.count
            });
        });
        
        // Create a stacked bar chart for commit types by author
        const margin = {top: 30, right: 150, bottom: 70, left: 60};
        const width = 700 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;
        
        // Create SVG
        const svg = d3.select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
        // Convert data to stacked format
        const authors = Object.keys(authorGroups);
        const allTypes = Array.from(new Set(commitTypesData.map(d => d.type)));
        
        // Prepare stacked data
        const stackedData = [];
        authors.forEach(author => {
            const authorData = { author };
            
            // Initialize all types to 0
            allTypes.forEach(type => {
                authorData[type] = 0;
            });
            
            // Update with actual values
            authorGroups[author].forEach(item => {
                authorData[item.type] = item.count;
            });
            
            stackedData.push(authorData);
        });
        
        // Create the stack generator
        const stack = d3.stack()
            .keys(allTypes)
            .order(d3.stackOrderDescending);
        
        const series = stack(stackedData);
        
        // Create color scale
        const color = d3.scaleOrdinal()
            .domain(allTypes)
            .range(d3.schemeCategory10);
        
        // Create x scale
        const x = d3.scaleBand()
            .domain(authors)
            .range([0, width])
            .padding(0.1);
        
        // Create y scale
        const y = d3.scaleLinear()
            .domain([0, d3.max(series, d => d3.max(d, d => d[1]))])
            .range([height, 0]);
        
        // Add x axis
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "10px");
        
        // Add y axis
        svg.append("g")
            .call(d3.axisLeft(y));
        
        // Add title
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .text("Commit Types by Contributor");
        
        // Add tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute")
            .style("background-color", "white")
            .style("border", "1px solid #ddd")
            .style("padding", "10px")
            .style("border-radius", "4px")
            .style("pointer-events", "none");
        
        // Add bars
        svg.append("g")
            .selectAll("g")
            .data(series)
            .enter().append("g")
            .attr("fill", d => color(d.key))
            .selectAll("rect")
            .data(d => d)
            .enter().append("rect")
            .attr("x", d => x(d.data.author))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth())
            .on("mouseover", function(event, d) {
                const type = this.parentNode.__data__.key;
                const count = d[1] - d[0];
                
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`
                    <strong>${d.data.author}</strong><br/>
                    Type: ${type}<br/>
                    Count: ${count}
                `)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        
        // Add legend
        const legend = svg.append("g")
            .attr("transform", `translate(${width + 20}, 0)`)
            .selectAll("g")
            .data(allTypes)
            .enter().append("g")
            .attr("transform", (d, i) => `translate(0, ${i * 20})`);
        
        legend.append("rect")
            .attr("width", 18)
            .attr("height", 18)
            .attr("fill", d => color(d));
        
        legend.append("text")
            .attr("x", 24)
            .attr("y", 9)
            .attr("dy", "0.35em")
            .text(d => d);
    }
    
    // Function to show file changes for a specific commit
    function showFileChanges(commitHash) {
        fetch(`/api/file-changes/${commitHash}`)
            .then(response => response.json())
            .then(fileChanges => {
                // Create a modal to display the changes
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.zIndex = '1000';
                modal.style.left = '0';
                modal.style.top = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.overflow = 'auto';
                modal.style.backgroundColor = 'rgba(0,0,0,0.4)';
                
                // Modal content
                const modalContent = document.createElement('div');
                modalContent.style.backgroundColor = '#fefefe';
                modalContent.style.margin = '10% auto';
                modalContent.style.padding = '20px';
                modalContent.style.border = '1px solid #888';
                modalContent.style.width = '80%';
                modalContent.style.maxHeight = '70%';
                modalContent.style.overflow = 'auto';
                
                // Close button
                const closeButton = document.createElement('span');
                closeButton.innerHTML = '&times;';
                closeButton.style.color = '#aaa';
                closeButton.style.float = 'right';
                closeButton.style.fontSize = '28px';
                closeButton.style.fontWeight = 'bold';
                closeButton.style.cursor = 'pointer';
                closeButton.onclick = function() {
                    document.body.removeChild(modal);
                };
                
                modalContent.appendChild(closeButton);
                
                // Heading
                const heading = document.createElement('h3');
                heading.textContent = `File Changes for Commit ${commitHash.substring(0, 7)}`;
                modalContent.appendChild(heading);
                
                // Table of file changes
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                
                // Table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Status</th>
                        <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Filename</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Table body
                const tbody = document.createElement('tbody');
                
                // Map status codes to readable names and colors
                const statusMap = {
                    'A': { text: 'Added', color: '#d0f0d0' },
                    'M': { text: 'Modified', color: '#e0e0f0' },
                    'D': { text: 'Deleted', color: '#f0d0d0' },
                    'R': { text: 'Renamed', color: '#f0f0d0' },
                    'C': { text: 'Copied', color: '#d0f0f0' },
                    'T': { text: 'Type Changed', color: '#f0d0f0' }
                };
                
                fileChanges.forEach(change => {
                    const row = document.createElement('tr');
                    
                    const statusInfo = statusMap[change.status] || { text: change.status, color: '#ffffff' };
                    
                    row.innerHTML = `
                        <td style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd; background-color: ${statusInfo.color};">
                            ${statusInfo.text}
                        </td>
                        <td style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">
                            ${change.filename}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                modalContent.appendChild(table);
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close when clicking outside the modal
                window.onclick = function(event) {
                    if (event.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            })
            .catch(error => {
                console.error('Error fetching file changes:', error);
                alert('Error loading file changes. Please try again.');
            });
    }
</script>
</body>
</html>
