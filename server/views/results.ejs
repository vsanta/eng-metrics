<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Analysis Results</title>
    <!-- Include D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Basic styling for the scatter plot and tooltip */
        #tooltip {
            position: absolute;
            display: none;
            padding: 8px;
            background-color: lightgray;
            border: 1px solid #333;
            border-radius: 4px;
        }
        /* Side panel styling */
        #sidePanel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100%;
            background: #f7f7f7;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
        }
        #sidePanel.open {
            right: 0;
        }
        #sidePanel h2 {
            margin-top: 0;
        }
        #closePanel {
            cursor: pointer;
            float: right;
            font-size: 18px;
            font-weight: bold;
        }
        /* Network graph styling */
        #networkGraph {
            margin-top: 30px;
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        /* Tab styling */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-top: 20px;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tabcontent.active {
            display: block;
        }
    </style>
</head>
<body>
<h1>Analysis Complete</h1>
<p>Total Creates: <%= totalCreates %></p>
<p>Total Edits: <%= totalEdits %></p>
<p>Since Date: <%= sinceDate %></p>

<!-- Store the analysis key so it can be used by the front end -->
<script>
    const analysisKey = "<%= analysisKey %>";
</script>

<!-- Tabs -->
<div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'scatterPlotTab')">Scatter Plot</button>
    <button class="tablinks" onclick="openTab(event, 'networkTab')">Collaboration Network</button>
</div>

<!-- Scatter Plot Tab -->
<div id="scatterPlotTab" class="tabcontent active">
    <div id="scatterPlot"></div>
    <div id="tooltip"></div>
</div>

<!-- Network Graph Tab -->
<div id="networkTab" class="tabcontent">
    <h2>Collaboration Network</h2>
    <p>This graph shows how developers collaborate. Each link represents one developer editing files created by another.</p>
    <p>Thicker lines indicate more frequent collaboration.</p>
    <div id="networkGraph"></div>
</div>

<!-- Top 20 Influencers -->
<h2>Top 20 Influencers</h2>
<ul>
    <% topInfluencers.forEach(influencer => { %>
        <li>
            <strong><%= influencer.author %></strong> – Influence Score: <%= influencer.influenceScore %>
            (Creates: <%= influencer.total_creates %>, Edits: <%= influencer.total_edits %>,
            Edited on Created Files: <%= influencer.times_edited_on_created_files %>)
        </li>
    <% }); %>
</ul>

<!-- Top 20 Creators -->
<h2>Top 20 Creators</h2>
<ul>
    <% topCreators.forEach(creator => { %>
        <li>
            <strong><%= creator.author %></strong> – Creates: <%= creator.creates %>
        </li>
    <% }); %>
</ul>

<!-- Top 20 Editors -->
<h2>Top 20 Editors</h2>
<ul>
    <% topEditors.forEach(editor => { %>
        <li>
            <strong><%= editor.author %></strong> – Edits: <%= editor.edits %>
        </li>
    <% }); %>
</ul>

<!-- Top 20 People Who Create Files That Get Edited -->
<h2>Top 20 People Whose Files Get Edited</h2>
<ul>
    <% topEditedCreators.forEach(item => { %>
        <li>
            <strong><%= item.author %></strong> – Times Edited: <%= item.times_edited %>
        </li>
    <% }); %>
</ul>
<!-- Side panel for detailed contributor info -->
<div id="sidePanel">
    <span id="closePanel">&times;</span>
    <div id="panelContent"></div>
</div>

<script>
    // Data injected from the server
    const dataPoints = <%- JSON.stringify(contributors || []) %>;
    const networkData = <%- JSON.stringify(networkData || []) %>;

    // Function to open tabs
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tabcontent");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }
        
        const tablinks = document.getElementsByClassName("tablinks");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    // Scatter Plot Visualization
    const width = 600, height = 400;
    const margin = { top: 50, right: 50, bottom: 50, left: 50 };

    const svg = d3.select("#scatterPlot")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // Scales: x for creates, y for edits.
    const xScale = d3.scaleLinear()
        .domain([0, d3.max(dataPoints, d => d.creates) + 5])
        .range([margin.left, width - margin.right]);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(dataPoints, d => d.edits) + 5])
        .range([height - margin.bottom, margin.top]);

    // X-axis (File Creations)
    const xAxis = d3.axisBottom(xScale);
    svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .call(xAxis)
        .append("text")
        .attr("x", width - margin.right)
        .attr("y", -10)
        .attr("fill", "#000")
        .style("text-anchor", "end")
        .text("File Creations");

    // Y-axis (File Edits)
    const yAxis = d3.axisLeft(yScale);
    svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -margin.top)
        .attr("y", 15)
        .attr("fill", "#000")
        .style("text-anchor", "end")
        .text("File Edits");

    // Tooltip for hover effect
    const tooltip = d3.select("#tooltip");

    // Plot data points with click handler to load contributor details
    svg.selectAll("circle")
        .data(dataPoints)
        .enter()
        .append("circle")
        .attr("cx", d => xScale(d.creates))
        .attr("cy", d => yScale(d.edits))
        .attr("r", 8)
        .attr("fill", "steelblue")
        .on("mouseover", function(event, d) {
            tooltip.style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .style("display", "inline-block")
                .html(`<strong>${d.author}</strong><br/>Creates: ${d.creates}<br/>Edits: ${d.edits}`);
        })
        .on("mouseout", () => {
            tooltip.style("display", "none");
        })
        .on("click", function(event, d) {
            // Include the analysisKey in the query parameter
            fetch(`/api/contributor/${encodeURIComponent(d.author)}?analysisKey=${encodeURIComponent(analysisKey)}`)
                .then(response => response.json())
                .then(details => {
                    showSidePanel(details);
                })
                .catch(err => {
                    console.error('Error fetching contributor details:', err);
                });
        });

    // Function to show side panel with contributor details
    function showSidePanel(details) {
        const panel = document.getElementById('sidePanel');
        const panelContent = document.getElementById('panelContent');
        panelContent.innerHTML = `
        <h2>${details.influenceRank} ${details.author}</h2>
        <p><strong>Creates:</strong> ${details.creates}</p>
        <p><strong>Edits:</strong> ${details.edits}</p>
        <p><strong>Edits on their files:</strong> ${details.editsToCreations}</p>
        <p><strong>Influence Score:</strong> ${details.influenceScore}</p>
        <p style="font-size: 0.9em; color: #555;">
          <em>
            Influence Score is calculated as: Edits + (Creates × Multiplier), where
            Multiplier = (Edits on created files > 0 ? Edits on created files : 1)
          </em>
        </p>
        <h3>Contributions per Repository</h3>
        ${details.perRepo && details.perRepo.length > 0 ? `
          <ul>
            ${details.perRepo.map(repo => `<li>${repo.repository}: ${repo.creates} creates, ${repo.edits} edits</li>`).join('')}
          </ul>
        ` : '<p>No per-repository data available.</p>'}
      `;
        panel.classList.add('open');
    }

    // Function to hide the side panel
    document.getElementById('closePanel').addEventListener('click', () => {
        document.getElementById('sidePanel').classList.remove('open');
    });

    // Network Graph Visualization
    document.addEventListener('DOMContentLoaded', function() {
        // Create force-directed graph when network tab is clicked
        document.querySelector('button[onclick="openTab(event, \'networkTab\')"]').addEventListener('click', createNetworkGraph);
    });

    function createNetworkGraph() {
        // Only create the graph once
        if (document.querySelector('#networkGraph svg')) return;
        
        const graphWidth = document.getElementById('networkGraph').clientWidth;
        const graphHeight = 500;
        
        // Create nodes from unique creators and editors
        const uniqueAuthors = new Set();
        networkData.forEach(d => {
            uniqueAuthors.add(d.creator);
            uniqueAuthors.add(d.editor);
        });
        
        const nodes = Array.from(uniqueAuthors).map(name => ({ id: name }));
        
        // Create links from collaboration data
        const links = networkData.map(d => ({
            source: d.creator,
            target: d.editor,
            value: d.collaboration_count
        }));
        
        // Create color scale for the nodes
        const color = d3.scaleOrdinal(d3.schemeCategory10);
        
        // Create force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody().strength(-200))
            .force("center", d3.forceCenter(graphWidth / 2, graphHeight / 2))
            .force("collision", d3.forceCollide().radius(30));
        
        // Create SVG for the network
        const svg = d3.select("#networkGraph")
            .append("svg")
            .attr("width", graphWidth)
            .attr("height", graphHeight);
            
        // Define arrow markers for directed graph
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("orient", "auto")
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#999");
            
        // Add links with varying stroke-width based on collaboration count
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrowhead)")
            .style("stroke-width", d => Math.sqrt(d.value));
            
        // Create node group for circles and labels
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .enter().append("g")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
                
        // Add circle to each node
        node.append("circle")
            .attr("class", "node")
            .attr("r", 10)
            .attr("fill", d => color(d.id))
            .append("title")
            .text(d => d.id);
            
        // Add text label to each node
        node.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(d => d.id);
            
        // Update positions on each tick of the simulation
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
                
            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
</script>
</body>
</html>
